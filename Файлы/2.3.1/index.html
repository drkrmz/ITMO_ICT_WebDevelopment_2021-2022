<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>2.3 Загрузка файлов - Course project</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "2.3.1 \u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430 \u0438 \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u044f \u0444\u0430\u0439\u043b\u043e\u0432", url: "#_top", children: [
              {title: "\u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430 \u0444\u0430\u0439\u043b\u043e\u0432 \u0441 \u0443\u043a\u0430\u0437\u0430\u043d\u0438\u0435\u043c \u0432\u043d\u0435\u0448\u043d\u0435\u0433\u043e \u043a\u043b\u044e\u0447\u0430 \u043d\u0430 \u0441\u0432\u044f\u0437\u043d\u044b\u0439 \u043e\u0431\u044a\u0435\u043a\u0442 \u0438 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435\u043c \u0438\u043c\u0435\u043d\u0438 \u0438 \u0440\u0430\u0437\u043c\u0435\u0440\u0430 \u0444\u0430\u0439\u043b\u0430 \u0432 \u0431\u0430\u0437\u0435 \u0434\u0430\u043d\u043d\u044b\u0445", url: "#_1" },
              {title: "C\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u043d\u0435\u0441\u043a\u043e\u043b\u044c\u043a\u0438\u0445 \u0444\u0430\u0439\u043b\u043e\u0432 \u0438 \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u044f \u043d\u0430 \u043c\u0430\u043a\u0441\u0438\u043c\u0430\u043b\u044c\u043d\u044b\u0439 \u0440\u0430\u0437\u043c\u0435\u0440 \u0444\u0430\u0439\u043b\u0430 \u0438 \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b\u0435 \u0434\u043b\u044f \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u0438\u044f \u0444\u0430\u0439\u043b\u043e\u0432", url: "#c" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../%D0%A1%D0%B8%D0%B3%D0%BD%D0%B0%D0%BB%D1%8B/2.4.1/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../%D0%A1%D0%B8%D0%B3%D0%BD%D0%B0%D0%BB%D1%8B/2.4.1/" class="btn btn-xs btn-link">
        2.4 Сигналы
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../%D0%9F%D0%B0%D0%B3%D0%B8%D0%BD%D0%B0%D1%86%D0%B8%D1%8F/2.2.2/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../%D0%9F%D0%B0%D0%B3%D0%B8%D0%BD%D0%B0%D1%86%D0%B8%D1%8F/2.2.2/" class="btn btn-xs btn-link">
        2.2.2 Кастомная пагинация
      </a>
    </div>
    
  </div>

    

    <h1 id="231">2.3.1 Загрузка и валидация файлов</h1>
<h2 id="_1">Загрузка файлов с указанием внешнего ключа на связный объект и сохранением имени и размера файла в базе данных</h2>
<p><strong>models.py</strong></p>
<pre><code>class Cover(models.Model):
    name = models.CharField(max_length=100, verbose_name='Название', null=True)
    size = models.IntegerField(verbose_name='Размер', null=True)
    type = models.CharField(verbose_name='Тип', blank=True, null=True, max_length=100)
    validate_file = FileValidator(max_size=1024 * 1000, content_types=('image/jpeg', 'image/png'))
    file = models.FileField(verbose_name='Файл', upload_to='media/', validators=[validate_file], null=True)

    def __str__(self):
        return self.name

class Book(models.Model):
    name = models.CharField(max_length=50, verbose_name='Название')
    author = models.ForeignKey('Author', on_delete=CASCADE, verbose_name='Автор', blank=True, null=True)
    publisher = models.ForeignKey('Publisher', on_delete=CASCADE, verbose_name='Издательство', blank=True, null=True)
    year = models.IntegerField(verbose_name='Год издания')
    section = models.ForeignKey('Section', on_delete=CASCADE, verbose_name='Раздел', blank=True, null=True)
    code = models.CharField(max_length=20, verbose_name='Шифр')
    new = models.CharField(max_length=20, verbose_name='Test', blank=True, null=True)
    date = models.DateField(verbose_name='Дата закрепления за читателем', blank=True, null=True)
    cover = models.ForeignKey('Cover', on_delete=CASCADE, verbose_name='Обложка', blank=True, null=True)

    def __str__(self):
        return self.name
</code></pre>
<p><strong>serializers.py</strong></p>
<pre><code>class CoverSerializer(serializers.ModelSerializer):

     class Meta:
       model = Cover
       fields = ['file']
</code></pre>
<p><strong>views.py</strong></p>
<pre><code>class CoverUpload(ViewSet):
    serializer_class = CoverSerializer

    def create(self, request):
        uploaded_file = request.FILES.get('file')
        Cover.objects.create(name=uploaded_file.name,
                             size=uploaded_file.size, file=uploaded_file)
        return Response()
</code></pre>
<p><strong>urls.py</strong></p>
<pre><code>router = routers.DefaultRouter()
router.register('upload', CoverUpload, basename=&quot;upload&quot;)

urlpatterns = [
    ...
    path('', include(router.urls))
]
</code></pre>
<p><img alt="Файлы 1" src="/images/files_1.png" /></p>
<h2 id="c">Cохранение нескольких файлов и валидация на максимальный размер файла и доступные для загрузки расширения файлов</h2>
<p><strong>models.py</strong></p>
<pre><code>class Cover(models.Model):
    name = models.CharField(max_length=100, verbose_name='Название', null=True)
    size = models.IntegerField(verbose_name='Размер', null=True)
    type = models.CharField(verbose_name='Тип', blank=True, null=True, max_length=100)
    validate_file = FileValidator(max_size=1024 * 1000, content_types=('image/jpeg', 'image/png'))
    file = models.FileField(verbose_name='Файл', upload_to='media/', validators=[validate_file], null=True)

    def __str__(self):
        return self.name

class Book(models.Model):
    name = models.CharField(max_length=50, verbose_name='Название')
    author = models.ForeignKey('Author', on_delete=CASCADE, verbose_name='Автор', blank=True, null=True)
    publisher = models.ForeignKey('Publisher', on_delete=CASCADE, verbose_name='Издательство', blank=True, null=True)
    year = models.IntegerField(verbose_name='Год издания')
    section = models.ForeignKey('Section', on_delete=CASCADE, verbose_name='Раздел', blank=True, null=True)
    code = models.CharField(max_length=20, verbose_name='Шифр')
    new = models.CharField(max_length=20, verbose_name='Test', blank=True, null=True)
    date = models.DateField(verbose_name='Дата закрепления за читателем', blank=True, null=True)
    cover = models.ForeignKey('Cover', on_delete=CASCADE, verbose_name='Обложка', blank=True, null=True)

    def __str__(self):
        return self.name
</code></pre>
<p><strong>validators.py</strong></p>
<pre><code>import magic

from django.utils.deconstruct import deconstructible
from django.template.defaultfilters import filesizeformat
from django.core.exceptions import ValidationError


@deconstructible
class FileValidator(object):
    error_messages = {
     'max_size': (&quot;Ensure this file size is not greater than %(max_size)s.&quot;
                  &quot; Your file size is %(size)s.&quot;),
     'content_type': &quot;Files of type %(content_type)s are not supported.&quot;,
    }

    def __init__(self, max_size=None, content_types=()):
        self.max_size = max_size
        self.content_types = content_types

    def __call__(self, data):
        if self.max_size is not None and data.size &gt; self.max_size:
            params = {
                'max_size': filesizeformat(self.max_size), 
                'size': filesizeformat(data.size),
            }
            raise ValidationError(self.error_messages['max_size'],
                                   'max_size', params)

        if self.content_types:
            content_type = magic.from_buffer(data.read(), mime=True)
            data.seek(0)

            if content_type not in self.content_types:
                params = { 'content_type': content_type }
                raise ValidationError(self.error_messages['content_type'],
                                   'content_type', params)
        return data



    def __eq__(self, other):
        return (
            isinstance(other, FileValidator) and
            self.max_size == other.max_size and
            self.content_types == other.content_types
        )
</code></pre>
<p><strong>serializers.py</strong></p>
<pre><code>class CoverSerializer(serializers.ModelSerializer):

     class Meta:
       model = Cover
       fields = ['file']
</code></pre>
<p><strong>views.py</strong></p>
<pre><code>class MultipleCoversView(ModelViewSet):
    serializer_class = CoverSerializer
    queryset = Cover.objects.all()

    def create(self, request):
        uploaded_files = request.FILES.getlist('file')
        for uploaded_file in uploaded_files:
         new_cover = Cover(name=uploaded_file.name, size=uploaded_file.size, file=uploaded_file, type=uploaded_file.content_type)
         new_cover.full_clean()
         new_cover.save()
        return Response()
</code></pre>
<p><strong>urls.py</strong></p>
<pre><code>router = routers.DefaultRouter()
router.register('upload_multiple', MultipleCoversView, basename=&quot;upload_multiple&quot;)

urlpatterns = [
    ...
    path('', include(router.urls))
]
</code></pre>
<p><img alt="Файлы 2" src="/images/files_2.png" />
<img alt="Файлы 3" src="/images/files_3.png" /></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../%D0%A1%D0%B8%D0%B3%D0%BD%D0%B0%D0%BB%D1%8B/2.4.1/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../%D0%A1%D0%B8%D0%B3%D0%BD%D0%B0%D0%BB%D1%8B/2.4.1/" class="btn btn-xs btn-link">
        2.4 Сигналы
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../%D0%9F%D0%B0%D0%B3%D0%B8%D0%BD%D0%B0%D1%86%D0%B8%D1%8F/2.2.2/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../%D0%9F%D0%B0%D0%B3%D0%B8%D0%BD%D0%B0%D1%86%D0%B8%D1%8F/2.2.2/" class="btn btn-xs btn-link">
        2.2.2 Кастомная пагинация
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="">Windmill Dark</a> theme by None (noraj).</p>
</footer>

</body>
</html>